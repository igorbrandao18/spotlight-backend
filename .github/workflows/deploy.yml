name: Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  SERVER_HOST: '134.209.174.77'
  SERVER_USER: 'root'
  SERVER_PASSWORD: '81927d75KZsaZZ12@1@L'
  DEPLOY_PATH: '/var/www/spotlight-backend'
  PORT: '8080'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Stop services and prepare
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: 22
          command_timeout: 10m
          script_stop: true
          script: |
            set +e
            echo "üöÄ Starting deployment..."
            echo "‚èπÔ∏è  Stopping existing services..."
            cd ${{ env.DEPLOY_PATH }} 2>/dev/null || true
            docker-compose down 2>/dev/null || true
            pm2 stop spotlight-backend 2>/dev/null || true
            pm2 delete spotlight-backend 2>/dev/null || true
            pkill -f "node.*dist/main" 2>/dev/null || true
            pkill -f "nest start" 2>/dev/null || true
            mkdir -p ${{ env.DEPLOY_PATH }}
            echo "‚úÖ Services stopped, directory ready"
            exit 0

      - name: Install dependencies
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: 22
          command_timeout: 20m
          script: |
            export DEBIAN_FRONTEND=noninteractive
            apt-get update -qq || true
            
            if ! command -v node &> /dev/null; then
              echo "üì¶ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi
            
            if ! command -v pnpm &> /dev/null; then
              echo "üì¶ Installing pnpm..."
              curl -fsSL https://get.pnpm.io/install.sh | sh -
              export PNPM_HOME="$HOME/.local/share/pnpm"
              export PATH="$PNPM_HOME:$PATH"
            else
              export PNPM_HOME="$HOME/.local/share/pnpm"
              export PATH="$PNPM_HOME:$PATH"
            fi
            
            if ! command -v pm2 &> /dev/null; then
              echo "üì¶ Installing PM2..."
              npm install -g pm2
            fi
            echo "‚úÖ Dependencies installed"

      - name: Update code
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: 22
          command_timeout: 10m
          script: |
            cd ${{ env.DEPLOY_PATH }}
            if [ -d .git ]; then
              echo "üì• Pulling latest changes..."
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            else
              echo "üì• Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            fi
            echo "‚úÖ Code updated"

      - name: Build and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: 22
          command_timeout: 30m
          script: |
            cd ${{ env.DEPLOY_PATH }}
            export PNPM_HOME="$HOME/.local/share/pnpm"
            export PATH="$PNPM_HOME:$PATH"
            
            if [ ! -f .env ]; then
              cp .env.example .env
              echo "‚ö†Ô∏è  Please configure .env file"
            fi
            
            echo "üì¶ Installing dependencies..."
            pnpm install --frozen-lockfile || exit 1
            
            echo "üîß Generating Prisma Client..."
            pnpm prisma generate || exit 1
            
            echo "üóÑÔ∏è  Running migrations..."
            pnpm prisma migrate deploy || echo "‚ö†Ô∏è  Migration warning"
            
            echo "üî® Building application..."
            NODE_ENV=production pnpm run build || exit 1
            
            echo "üöÄ Starting application..."
            pm2 start dist/main.js \
              --name spotlight-backend \
              --instances 1 \
              --exec-mode fork \
              --env production \
              --log-date-format "YYYY-MM-DD HH:mm:ss Z" \
              --merge-logs \
              --max-memory-restart 500M || exit 1
            
            pm2 save || true
            pm2 startup systemd -u ${{ env.SERVER_USER }} --hp /root || true
            
            echo "‚úÖ Deployment completed!"
            pm2 status

      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: 22
          script: |
            sleep 10
            echo "üîç Verifying deployment..."
            
            # Check PM2 status
            pm2 status
            
            # Check if application is responding
            echo "üåê Testing API endpoint..."
            curl -f http://localhost:${{ env.PORT }}/api/docs && echo "‚úÖ API is responding" || echo "‚ö†Ô∏è  API health check failed"
            
            # Check process
            echo "üîç Checking process..."
            ps aux | grep "node.*dist/main" | grep -v grep || echo "‚ö†Ô∏è  Process not found"

